<div th:fragment="buscar_proveedor">
    <!-- Formulario de búsqueda -->
    <div class="container mx-auto relative mb-8 bg-white p-6 rounded-lg shadow">
        <form id="search-form" method="post" th:action="@{/administracion/proveedor/buscar}" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Campo RFC -->
                <div class="relative">
                    <label class="block text-zorroDark font-medium mb-2">RFC</label>
                    <input type="text" id="rfc" name="rfc" th:value="${param.rfc}"
                           class="w-full p-3 border border-gray-300 rounded focus:ring-2 focus:ring-zorroRed focus:border-transparent autocomplete-field"
                           data-suggestions-url="/administracion/proveedor/sugerencias/rfc"
                           autocomplete="off">
                    <div class="suggestions-dropdown hidden absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded shadow-lg max-h-60 overflow-auto"></div>
                </div>

                <!-- Campo Razón Social -->
                <div class="relative">
                    <label class="block text-zorroDark font-medium mb-2">Razón Social</label>
                    <input type="text" id="razonSocial" name="razonSocial"
                           th:value="${param.razonSocial}"
                           class="w-full p-3 border border-gray-300 rounded focus:ring-2 focus:ring-zorroRed focus:border-transparent autocomplete-field"
                           data-suggestions-url="/administracion/proveedor/sugerencias/razon-social"
                           autocomplete="off">
                    <div class="suggestions-dropdown hidden absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded shadow-lg max-h-60 overflow-auto"></div>
                </div>

                <!-- Campo Correo -->
                <div class="relative">
                    <label class="block text-zorroDark font-medium mb-2">Correo</label>
                    <input type="text" id="correo" name="correo" th:value="${param.correo}"
                           class="w-full p-3 border border-gray-300 rounded focus:ring-2 focus:ring-zorroRed focus:border-transparent autocomplete-field"
                           data-suggestions-url="/administracion/proveedor/sugerencias/correo"
                           autocomplete="off">
                    <div class="suggestions-dropdown hidden absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded shadow-lg max-h-60 overflow-auto"></div>
                </div>
            </div>
            <button type="submit" class="bg-zorroRed text-white px-6 py-3 rounded-md hover:bg-zorroDark transition-colors font-medium">
                Buscar Proveedor
            </button>
        </form>
    </div>



    <div th:if="${proveedorEncontrado}" class="mt-12 border-t pt-8">
        <div class="bg-grayLight p-6 rounded-lg border border-gray-200 shadow-sm">
            <div class="flex justify-between items-start mb-6">
                <h3 class="text-xl font-semibold text-zorroDark">Proveedor encontrado</h3>
                <div class="flex space-x-3">
                    <a href="#" class="bg-white text-zorroRed border border-zorroRed px-4 py-2 rounded-md hover:bg-zorroRed hover:text-white transition-colors font-medium">
                        Editar
                    </a>
                    <button class="bg-zorroRed text-white px-4 py-2 rounded-md hover:bg-zorroDark transition-colors font-medium">
                        Eliminar
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Columna Izquierda -->
                <div class="space-y-4">
                    <div>
                        <p class="text-sm text-gray-500">RFC</p>
                        <p class="text-gray-800 font-semibold text-lg" th:text="${proveedorEncontrado.rfc}"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Razón Social</p>
                        <p class="text-gray-800 font-semibold text-lg" th:text="${proveedorEncontrado.razonSocial}"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Régimen Fiscal</p>
                        <p class="text-gray-800 font-semibold text-lg">
                        <span th:switch="${proveedorEncontrado.regimenFiscal.name()}">
                        <span th:case="'_601'">601 - Régimen General de Ley Personas Morales</span>
                        <span th:case="'_603'">603 - Personas Morales con Fines no Lucrativos</span>
                        <span th:case="'_605'">605 - Régimen de Sueldos y Salarios e Ingresos Asimilados a Salarios</span>
                        <span th:case="'_606'">606 - Régimen de Arrendamiento</span>
                        <span th:case="'_612'">612 - Régimen de las Personas Físicas con Actividades Empresariales y Profesionales</span>
                        <span th:case="'_621'">621 - Régimen de Incorporación Fiscal</span>
                        <span th:case="'_625'">625 - Régimen de las Actividades Empresariales con Ingresos a Través de Plataformas Tecnológicas</span>
                        <span th:case="'_626'">626 - Régimen Simplificado de Confianza</span>
                        <span th:case="*">Desconocido (<span th:text="${proveedorEncontrado.regimenFiscal}"></span>)</span>
                    </span>
                        </p>
                    </div>
                </div>

                <!-- Columna Derecha -->
                <div class="space-y-4">
                    <div>
                        <p class="text-sm text-gray-500">Correo Electrónico</p>
                        <p class="text-gray-800 font-semibold text-lg" th:text="${proveedorEncontrado.correo}"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Teléfono</p>
                        <p class="text-gray-800 font-semibold text-lg" th:text="${proveedorEncontrado.telefono}"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Estatus</p>
                        <p class="text-gray-800 font-semibold text-lg" th:text="${proveedorEncontrado.estatus}"></p>
                    </div>
                </div>
            </div>

            <!-- Información Adicional -->
            <div class="mt-6 pt-6 border-t border-gray-200">
                <h4 class="text-md font-medium text-zorroDark mb-3">Información Adicional</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <p class="text-sm text-gray-500">Dirección</p>
                        <p class="text-gray-800 font-semibold text-lg" th:text="${proveedorEncontrado.direccion}"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Código Postal</p>
                        <p class="text-gray-800 font-semibold text-lg" th:text="${proveedorEncontrado.codigoPostal}"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Persona de Contacto</p>
                        <p class="text-gray-800 font-semibold text-lg" th:text="${proveedorEncontrado.contactoNombre}"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Script cargado correctamente"); // Verificación de carga

            // Función debounce para limitar peticiones
            function debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            // Configurar autocompletado para cada campo
            document.querySelectorAll('.autocomplete-field').forEach(input => {
                console.log("Configurando autocompletado para:", input.id); // Verificación

                const dropdown = input.nextElementSibling;
                const suggestionsUrl = input.dataset.suggestionsUrl;

                // Evento de entrada con debounce
                input.addEventListener('input', debounce(function(e) {
                    const termino = e.target.value.trim();
                    console.log("Input detectado en", input.id, "con valor:", termino); // Verificación

                    if (termino.length >= 2) {
                        console.log("Haciendo petición a:", suggestionsUrl); // Verificación

                        fetch(`${suggestionsUrl}?termino=${encodeURIComponent(termino)}&limite=5`)
                            .then(response => {
                                if (!response.ok) throw new Error('Error en la respuesta');
                                return response.json();
                            })
                            .then(data => {
                                console.log("Respuesta recibida:", data); // Verificación
                                mostrarSugerencias(data, dropdown, input);
                            })
                            .catch(error => {
                                console.error('Error al obtener sugerencias:', error);
                                dropdown.classList.add('hidden');
                            });
                    } else {
                        dropdown.classList.add('hidden');
                    }
                }, 300));

                // Ocultar dropdown al hacer clic fuera
                document.addEventListener('click', function(e) {
                    if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
            });

            // Función para mostrar sugerencias
            function mostrarSugerencias(sugerencias, dropdown, input) {
                console.log("Mostrando sugerencias:", sugerencias); // Verificación

                dropdown.innerHTML = '';

                if (!sugerencias || sugerencias.length === 0) {
                    dropdown.classList.add('hidden');
                    return;
                }

                sugerencias.forEach(sugerencia => {
                    const item = document.createElement('div');
                    item.className = 'p-2 hover:bg-gray-100 cursor-pointer border-b border-gray-200 last:border-b-0';

                    // Determinar qué campo mostrar según el input
                    let displayText = '';
                    if (input.id === 'rfc') {
                        displayText = sugerencia.rfc || '';
                    } else if (input.id === 'razonSocial') {
                        displayText = sugerencia.razonSocial || '';
                    } else if (input.id === 'correo') {
                        displayText = sugerencia.correo || '';
                    }

                    item.textContent = displayText;

                    item.addEventListener('click', function() {
                        input.value = displayText;
                        dropdown.classList.add('hidden');
                        console.log("Sugerencia seleccionada:", displayText); // Verificación
                    });

                    dropdown.appendChild(item);
                });

                dropdown.classList.remove('hidden');
            }
        });
    </script>
</div>